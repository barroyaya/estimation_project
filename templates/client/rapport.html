{# template/client/rapport.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}Rapport - {{ projet.nom }}{% endblock %}

{% block extra_css %}
<style>
  /* === Mélanges de couleurs (sans violet) === */
  :root{
    --mix-cool:   linear-gradient(135deg,#3C5FA4 0%,#22D3EE 100%);   /* bleu → cyan */
    --mix-fresh:  linear-gradient(135deg,#10B981 0%,#34D399 100%);   /* vert → turquoise */
    --mix-warm:   linear-gradient(135deg,#F59E0B 0%,#F97316 100%);   /* ambre → corail */
    --mix-danger: linear-gradient(135deg,#EF4444 0%,#F43F5E 100%);   /* rouges */
  }

  /* === En-tête Rapport === */
  .rapport-header{
    background: var(--mix-cool);
    color:#fff; border-radius: var(--radius-xl);
    padding: 2.5rem; margin-bottom: 2rem; position:relative; overflow:hidden;
    box-shadow: var(--shadow-xl);
  }
  .rapport-header::before{
    content:''; position:absolute; top: -100px; right:-100px;
    width: 300px; height:300px; background: rgba(255,255,255,.12); border-radius:50%;
  }
  .rapport-header::after{
    content:''; position:absolute; bottom:-60px; left:-60px;
    width:200px; height:200px; background: rgba(255,255,255,.08); border-radius:50%;
  }
  .company-logo{ max-height:80px; filter: brightness(0) invert(1); opacity:.9; transition:.3s }
  .company-logo:hover{ opacity:1; transform: scale(1.04) }
  .rapport-title{ font-size:2.5rem; font-weight:800; margin-bottom:.75rem; text-shadow:0 2px 10px rgba(0,0,0,.3) }
  .rapport-subtitle{ font-size:1.5rem; font-weight:600; margin-bottom:.25rem }
  .rapport-meta{ opacity:.9; font-size:1rem }

  /* === Sections Catégorie === */
  .category-section{
    background: rgba(255,255,255,.96);
    backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px);
    border:1px solid rgba(0,0,0,.04);
    border-radius: var(--radius-lg);
    margin-bottom: 1.25rem; overflow:hidden;
    box-shadow: var(--shadow-md); transition: transform .25s ease, box-shadow .25s;
  }
  .category-section:hover{ transform: translateY(-3px); box-shadow: var(--shadow-lg) }

  .category-header{
    color:#fff; padding: 1.2rem 1.5rem;
    display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;
  }
  .category-title{ display:flex; align-items:center; gap:.75rem; font-size:1.2rem; font-weight:700; margin:0 }
  .category-icon{ font-size:1.25rem; padding:.5rem; background: rgba(255,255,255,.22); border-radius:50% }
  .category-total{
    background: rgba(255,255,255,.18); padding:.5rem 1rem; border-radius: var(--radius-md);
    font-weight:700; backdrop-filter: blur(8px);
  }

  /* Header par type (couleur) */
  .kind-main_oeuvre .category-header{ background: var(--mix-fresh) }
  .kind-materiel   .category-header{ background: var(--mix-warm); color:#111827 }
  .kind-transport  .category-header{ background: var(--mix-warm); color:#111827 }
  .kind-etude      .category-header{ background: var(--mix-cool) }
  .category-section:not([class*="kind-"]) .category-header{ background: var(--mix-cool) }

  /* Table éléments (teintes douces par type) */
  .elements-table{ background:transparent; margin:0 }
  .elements-table thead th{
    color: var(--text-primary); border:none; font-weight:700;
    text-transform:uppercase; font-size:.85rem; letter-spacing:.05em; padding:1rem 1rem;
    border-bottom:2px solid var(--border-color);
  }
  .elements-table td{ padding: 1rem; vertical-align: middle; border:none }
  .elements-table tbody tr{ transition:.25s ease; border-bottom:1px solid var(--border-color) }

  .kind-main_oeuvre .elements-table thead th{ background: linear-gradient(135deg, rgba(16,185,129,.10), rgba(52,211,153,.10)) }
  .kind-materiel   .elements-table thead th,
  .kind-transport  .elements-table thead th{ background: linear-gradient(135deg, rgba(245,158,11,.12), rgba(249,115,22,.10)) }
  .kind-etude      .elements-table thead th,
  .elements-table  .thead-cool{ background: linear-gradient(135deg, rgba(60,95,164,.12), rgba(34,211,238,.10)) }

  .kind-main_oeuvre .elements-table tbody tr:hover{ background: rgba(16,185,129,.06) }
  .kind-materiel   .elements-table tbody tr:hover,
  .kind-transport  .elements-table tbody tr:hover{ background: rgba(245,158,11,.08) }
  .kind-etude      .elements-table tbody tr:hover,
  .elements-table  tbody tr:hover{ background: rgba(60,95,164,.06) }

  .element-standard{ transition:.25s }
  .element-personnalise{
    background: linear-gradient(135deg, rgba(16,185,129,.10), rgba(52,211,153,.06)) !important;
    border-left: 4px solid #10B981; position:relative;
  }
  .element-personnalise::before{
    content:''; position:absolute; top:0; left:0; height:2px; width:100%;
    background: linear-gradient(90deg,#10B981,transparent);
  }
  .element-sablage{
    background: linear-gradient(135deg, rgba(245,158,11,.12), rgba(249,115,22,.06)) !important;
    border-left:4px solid #F59E0B; position:relative;
  }
  .element-sablage::before{
    content:''; position:absolute; top:0; left:0; height:2px; width:100%;
    background: linear-gradient(90deg,#F59E0B,transparent);
  }
  .element-sablage-temp{
    background: linear-gradient(135deg, rgba(245,158,11,.08), rgba(249,115,22,.04)) !important;
    border-left:4px dashed #F59E0B; position:relative;
  }

  .element-designation{ font-weight:700; color:var(--text-primary); margin-bottom:.25rem }
  .element-numero{ font-size:.85rem; color:var(--text-secondary); font-style:italic }

  .element-personnalise-badge{
    display:inline-flex; align-items:center; gap:.5rem;
    background: var(--mix-fresh); color:#fff; padding:.25rem .75rem;
    border-radius: var(--radius-sm); font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.02em;
    box-shadow: var(--shadow-sm);
  }
  .element-sablage-badge{
    display:inline-flex; align-items:center; gap:.5rem;
    background: var(--mix-warm); color:#111827; padding:.25rem .75rem;
    border-radius: var(--radius-sm); font-size:.8rem; font-weight:700; text-transform:uppercase; letter-spacing:.02em;
    box-shadow: var(--shadow-sm);
  }

  .price-cell{
    font-weight:800;
    background: var(--mix-fresh);
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    font-size:1.05em;
  }
  .total-price{ font-size:1.1em; font-weight:800 }

  /* === Résumé & Répartition === */
  .summary-section{
    display:grid; grid-template-columns: 2fr 1fr; gap: 1.25rem; margin: 1.5rem 0 2rem;
  }
  .cost-breakdown{
    background: rgba(255,255,255,.96); backdrop-filter: blur(18px);
    border:1px solid rgba(0,0,0,.05); border-radius: var(--radius-lg);
    overflow:hidden; box-shadow: var(--shadow-md);
  }
  .breakdown-header{ background: var(--mix-fresh); color:#fff; padding:1.2rem; text-align:center }
  .breakdown-title{ display:flex; align-items:center; justify-content:center; gap:.6rem; margin:0; font-weight:700 }
  .breakdown-content{ padding:1.5rem }

  .cost-item{
    display:flex; justify-content:space-between; align-items:center;
    padding: .85rem 0; border-bottom:1px solid var(--border-color); transition:.25s;
  }
  .cost-item:last-child{ border-bottom:none }
  .cost-item:hover{ background: rgba(60,95,164,.06); transform: translateX(5px); border-radius: var(--radius-sm); padding-left:.75rem }
  .cost-label{ display:flex; align-items:center; gap:.6rem; font-weight:600; color:var(--text-primary) }
  .cost-value{
    font-weight:800;
    background: var(--mix-cool);
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    font-size:1.05em;
  }

  .financial-summary{
    background: var(--mix-cool); color:#fff; border-radius: var(--radius-lg);
    padding: 1.6rem; position:relative; overflow:hidden; box-shadow: var(--shadow-xl);
  }
  .financial-summary::before{
    content:''; position:absolute; top:-50px; right:-50px; width:150px; height:150px; border-radius:50%;
    background: rgba(255,255,255,.14);
  }
  .summary-title{ text-align:center; margin-bottom:1rem }
  .summary-title h4{ font-size:1.35rem; font-weight:800; margin-bottom:.35rem }
  .summary-item{
    display:flex; justify-content:space-between; align-items:center;
    padding:.6rem 0; border-bottom:1px solid rgba(255,255,255,.2); font-size:1.05rem;
  }
  .summary-item:last-of-type{ border-bottom:2px solid rgba(255,255,255,.28); margin-bottom:.8rem }
  .summary-total{
    display:flex; justify-content:space-between; align-items:center;
    background: rgba(255,255,255,.12); border-radius: var(--radius-md);
    padding: 1rem; margin: .6rem 0 1rem;
    backdrop-filter: blur(8px);
  }
  .total-amount{ font-size:1.45rem; font-weight:900 }

  .summary-meta{
    text-align:center; opacity:.9; font-size:.92rem;
    border-top:1px solid rgba(255,255,255,.22); padding-top:.75rem;
  }

  /* === États & Actions === */
  .empty-state{
    text-align:center; padding: 3rem 1.5rem;
    background: rgba(255,255,255,.96); border:1px solid rgba(0,0,0,.05);
    border-radius: var(--radius-xl); box-shadow: var(--shadow-md);
  }
  .empty-icon{ font-size:4rem; color: var(--text-secondary); opacity:.7; margin-bottom:1rem }

  .actions-section{ margin-top: 2rem; padding-top: 1.25rem; border-top:1px solid var(--border-color) }
  .action-buttons{ display:flex; justify-content:space-between; gap:1rem; flex-wrap:wrap }
  .btn-group-custom{ display:flex; gap:.6rem; flex-wrap:wrap }

  .btn-enhanced{
    padding:.7rem 1.3rem; font-weight:700; border-radius: var(--radius-md);
    transition:.3s; position:relative; overflow:hidden;
  }
  .btn-enhanced::before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background: linear-gradient(90deg,transparent,rgba(255,255,255,.26),transparent);
    transition:.5s;
  }
  .btn-enhanced:hover::before{ left:100% }
  .btn-enhanced:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg) }

  /* Variantes boutons */
  .btn-mix-cool{  background: var(--mix-cool);  color:#fff; border:none }
  .btn-mix-fresh{ background: var(--mix-fresh); color:#fff; border:none }
  .btn-mix-warm{  background: var(--mix-warm);  color:#111827; border:none }
  .btn-mix-danger{background: var(--mix-danger);color:#fff; border:none }
  .btn-outline-cool{ border:2px solid #3C5FA4; color:#3C5FA4; background:transparent }
  .btn-outline-cool:hover{ background: var(--mix-cool); color:#fff; border-color:transparent }

  /* === Impression === */
  @media print{
    .no-print{ display:none !important }
    body{ background:#fff !important; font-size:11px }
    .category-section{ border:1px solid #ddd !important; box-shadow:none !important; background:#fff !important }
    .rapport-header, .category-header, .financial-summary{
      background:#3C5FA4 !important; color:#fff !important;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }
    .elements-table thead th{ background:#eaf0ff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact }
    .page-break{ page-break-before: always }
  }

  /* === Responsive === */
  @media (max-width: 768px){
    .summary-section{ grid-template-columns:1fr; gap:1rem }
    .rapport-title{ font-size:2rem }
    .rapport-subtitle{ font-size:1.2rem }
    .category-header{ flex-direction:column; text-align:center }
    .elements-table{ font-size:.92rem }
    .elements-table td{ padding:.75rem .6rem }
    .action-buttons{ flex-direction:column; align-items:stretch }
    .btn-group-custom{ justify-content:center }
  }

  .fade-in-up{ animation: fadeInUp .7s ease-out }
  @keyframes fadeInUp{ from{ opacity:0; transform: translateY(28px) } to{ opacity:1; transform:none } }
</style>
{% endblock %}

{% block content %}
<!-- En-tête -->
<div class="rapport-header fade-in-up">
  <div class="row align-items-center">
    <div class="col-lg-8">
      <h1 class="rapport-title"><i class="fas fa-file-invoice me-3"></i> Rapport d'Estimation</h1>
      <h2 class="rapport-subtitle">{{ projet.nom }}</h2>
      {% if projet.client %}
      <div class="rapport-meta">
        <i class="fas fa-building me-2"></i> Client : <strong>{{ projet.client }}</strong>
      </div>
      {% endif %}
    </div>
    <div class="col-lg-4 text-lg-end text-center mt-3 mt-lg-0">
      <img src="{% static 'img/logo.jpg' %}" alt="Logo Entreprise" class="company-logo img-fluid mb-3">
      <div class="rapport-meta">
        <div class="mb-1">
          <i class="fas fa-calendar-alt me-2"></i>
          Date : <strong>{{ summary.derniere_mise_a_jour|date:"d/m/Y" }}</strong>
        </div>
        <div>
          <i class="fas fa-clock me-2"></i>
          {{ summary.derniere_mise_a_jour|date:"H:i" }}
        </div>
      </div>
    </div>
  </div>
</div>

{% if elements_par_categorie %}
  {# === Détail par catégorie === #}
  {% for categorie_nom, data in elements_par_categorie.items %}
  <div class="category-section fade-in-up kind-{% if data.categorie %}{{ data.categorie.type_categorie }}{% else %}autre{% endif %}">
    <div class="category-header">
      <div class="category-title">
        <div class="category-icon">
          {% if data.categorie and data.categorie.type_categorie == 'materiel' %}<i class="fas fa-tools"></i>
          {% elif data.categorie and data.categorie.type_categorie == 'main_oeuvre' %}<i class="fas fa-users"></i>
          {% elif data.categorie and data.categorie.type_categorie == 'transport' %}<i class="fas fa-truck"></i>
          {% elif data.categorie and data.categorie.type_categorie == 'etude' %}<i class="fas fa-clipboard-list"></i>
          {% else %}<i class="fas fa-layer-group"></i>{% endif %}
        </div>
        <span>{{ categorie_nom }}</span>
      </div>
      <div class="category-total">
        <i class="fas fa-coins me-2"></i> Total : {{ data.total|floatformat:2 }} CFA
        {% if data.sablage_temporaire %}
          <small class="d-block" style="color:#111827">
            <i class="fas fa-clock me-1"></i> + {{ data.sablage_temporaire.prix_total|floatformat:2 }} CFA (sablage en cours)
          </small>
        {% endif %}
      </div>
    </div>

    <div class="table-responsive">
      <table class="elements-table table">
        <thead>
          <tr>
            <th><i class="fas fa-tag me-2"></i>Désignation</th>
            <th><i class="fas fa-info-circle me-2"></i>Caractéristiques</th>
            <th><i class="fas fa-money-bill me-2"></i>Prix unitaire</th>
            <th><i class="fas fa-calculator me-2"></i>Quantité</th>
            <th><i class="fas fa-ruler me-2"></i>Unité</th>
            <th><i class="fas fa-coins me-2"></i>Total</th>
          </tr>
        </thead>
        <tbody>
          {# Éléments standards #}
          {% for element in data.elements %}
          <tr class="element-standard">
            <td>
              <div class="element-designation">{{ element.designation }}</div>
              {% if element.element and element.element.numero %}
                <div class="element-numero">Réf : {{ element.element.numero }}</div>
              {% endif %}
            </td>
            <td>{{ element.caracteristiques|default:"-" }}</td>
            <td class="price-cell">{{ element.prix_unitaire_utilise|floatformat:2 }} CFA</td>
            <td><strong>{{ element.quantite|floatformat:2 }}</strong></td>
            <td>{{ element.unite_display }}</td>
            <td class="price-cell total-price">{{ element.cout_total|floatformat:2 }} CFA</td>
          </tr>
          {% endfor %}

          {# Sablage validé #}
          {% for element_sablage in data.elements_sablage %}
          <tr class="element-sablage">
            <td>
              <div class="element-designation">{{ element_sablage.designation|default:"Sablage Tuyauterie" }}</div>
              <div class="mt-2">
                <span class="element-sablage-badge"><i class="fas fa-spray-can"></i> Sablage Tuyauterie</span>
              </div>
            </td>
            <td>{{ element_sablage.caracteristiques|default:"-" }}</td>
            <td class="price-cell">{{ element_sablage.prix_unitaire_utilise|floatformat:2 }} CFA</td>
            <td><strong>{{ element_sablage.quantite|floatformat:3 }}</strong></td>
            <td>{{ element_sablage.unite_display|default:"m²" }}</td>
            <td class="price-cell total-price">{{ element_sablage.cout_total|floatformat:2 }} CFA</td>
          </tr>
          {% endfor %}

          {# Sablage temporaire #}
          {% if data.sablage_temporaire %}
          <tr class="element-sablage-temp">
            <td>
              <div class="element-designation">Sablage Tuyauterie (en cours)</div>
              <div class="mt-2">
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-clock"></i> {{ data.sablage_temporaire.nb_elements }} élément(s) temporaire(s)
                </span>
              </div>
              <div class="small text-muted mt-2">
                {% for elem_temp in data.sablage_temporaire.elements %}
                  {{ elem_temp.nom_type_piece }} {{ elem_temp.nom_dn }} ({{ elem_temp.quantite|floatformat:2 }}){% if not forloop.last %}, {% endif %}
                {% endfor %}
              </div>
              <div class="mt-2">
                <a href="{% url 'sablage_tuyauterie' data.categorie.id %}" class="btn btn-sm btn-outline-warning">
                  <i class="fas fa-edit me-1"></i> Finaliser le calcul
                </a>
              </div>
            </td>
            <td>Surface : {{ data.sablage_temporaire.surface_globale|floatformat:3 }} m²</td>
            <td class="price-cell">{{ data.sablage_temporaire.prix_unitaire|floatformat:2 }} CFA</td>
            <td><strong>{{ data.sablage_temporaire.surface_globale|floatformat:3 }}</strong></td>
            <td>m²</td>
            <td class="price-cell" style="color:#b45309; font-style:italic;">
              {{ data.sablage_temporaire.prix_total|floatformat:2 }} CFA
              <br><small>(non validé)</small>
            </td>
          </tr>
          {% endif %}

          {# Personnalisés approuvés #}
          {% for demande in data.demandes_approuvees %}
          <tr class="element-personnalise">
            <td>
              <div class="element-designation">{{ demande.designation }}</div>
              <div class="mt-2">
                <span class="element-personnalise-badge"><i class="fas fa-user-plus"></i> Élément personnalisé</span>
              </div>
            </td>
            <td>{{ demande.caracteristiques|default:"-" }}</td>
            <td class="price-cell">{{ demande.prix_unitaire_admin|floatformat:2 }} CFA</td>
            <td><strong>{{ demande.quantite|floatformat:2 }}</strong></td>
            <td>{{ demande.get_unite_display }}</td>
            <td class="price-cell total-price">{{ demande.cout_total|floatformat:2 }} CFA</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endfor %}

  <!-- Résumé -->
  <div class="summary-section fade-in-up">
    <!-- Répartition -->
    <div class="cost-breakdown">
      <div class="breakdown-header">
        <h5 class="breakdown-title"><i class="fas fa-chart-pie"></i> Répartition des Coûts</h5>
      </div>
      <div class="breakdown-content">
        {% if summary.cout_total_materiel > 0 %}
        <div class="cost-item">
          <div class="cost-label"><i class="fas fa-tools" style="color:#f59e0b"></i> Matériel</div>
          <div class="cost-value">{{ summary.cout_total_materiel|floatformat:2 }} CFA</div>
        </div>
        {% endif %}

        {% if summary.cout_total_main_oeuvre > 0 %}
        <div class="cost-item">
          <div class="cost-label">
            <i class="fas fa-users" style="color:#10b981"></i> Main d'œuvre
            {% if totaux_par_type.sablage > 0 %}
              <small class="d-block text-muted">dont {{ totaux_par_type.sablage|floatformat:2 }} CFA de sablage</small>
            {% endif %}
          </div>
          <div class="cost-value">{{ summary.cout_total_main_oeuvre|floatformat:2 }} CFA</div>
        </div>
        {% endif %}

        {% if summary.cout_total_transport > 0 %}
        <div class="cost-item">
          <div class="cost-label"><i class="fas fa-truck" style="color:#f97316"></i> Transport</div>
          <div class="cost-value">{{ summary.cout_total_transport|floatformat:2 }} CFA</div>
        </div>
        {% endif %}

        {% if summary.cout_total_etude > 0 %}
        <div class="cost-item">
          <div class="cost-label"><i class="fas fa-clipboard-list" style="color:#3C5FA4"></i> Études</div>
          <div class="cost-value">{{ summary.cout_total_etude|floatformat:2 }} CFA</div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Résumé Financier -->
    <div class="financial-summary">
      <div class="summary-title">
        <h4><i class="fas fa-calculator me-2"></i> Résumé Financier</h4>
        <small class="opacity-75">Synthèse des coûts du projet</small>
        {% if has_sablage %}
        <div class="mt-2">
          <span class="badge bg-light text-warning"><i class="fas fa-spray-can me-1"></i> Inclut du sablage tuyauterie</span>
        </div>
        {% endif %}
      </div>

      <div class="summary-item"><span>Sous-total HT</span><strong>{{ summary.cout_total_ht|floatformat:2 }} CFA</strong></div>
      <div class="summary-item"><span>TVA ({{ summary.tva_taux }}%)</span><strong>{{ summary.tva_montant|floatformat:2 }} CFA</strong></div>
      <div class="summary-total"><span>Total TTC</span><span class="total-amount">{{ summary.cout_total_ttc|floatformat:2 }} CFA</span></div>

      <div class="summary-meta">
        <i class="fas fa-info-circle me-1"></i>
        {{ total_elements }} élément{{ total_elements|pluralize }} sélectionné{{ total_elements|pluralize }}
        {% if has_sablage %}<br><i class="fas fa-spray-can me-1 mt-2"></i> Calculs de sablage inclus{% endif %}
        <br><i class="fas fa-check-circle me-1 mt-2"></i> Estimation validée le {{ summary.derniere_mise_a_jour|date:"d/m/Y à H:i" }}
      </div>
    </div>
  </div>

{% else %}
  <!-- État vide -->
  <div class="empty-state fade-in-up">
    <div class="empty-icon"><i class="fas fa-inbox"></i></div>
    <h3 class="text-muted mb-2">Aucun élément sélectionné</h3>
    <p class="text-muted mb-4">
      Votre projet ne contient pas encore d'éléments d'estimation.<br>
      Commencez par sélectionner des éléments pour générer votre rapport.
    </p>
    <a href="{% url 'category_selection' %}" class="btn btn-mix-cool btn-enhanced">
      <i class="fas fa-plus-circle me-2"></i> Ajouter des éléments
    </a>
  </div>
{% endif %}

<!-- Actions -->
<div class="actions-section no-print fade-in-up">
  <div class="action-buttons">
    <div class="btn-group-custom">
      <a href="{% url 'category_selection' %}" class="btn btn-outline-cool btn-enhanced">
        <i class="fas fa-edit me-2"></i> Modifier la sélection
      </a>
      <a href="{% url 'project_selection' %}" class="btn btn-secondary btn-enhanced">
        <i class="fas fa-arrow-left me-2"></i> Autres projets
      </a>
    </div>
    <div class="btn-group-custom">
      <button onclick="window.print()" class="btn btn-mix-fresh btn-enhanced">
        <i class="fas fa-print me-2"></i> Imprimer
      </button>
      <a href="{% url 'export_pdf' projet.id %}" class="btn btn-mix-warm btn-enhanced">
        <i class="fas fa-file-pdf me-2"></i> Exporter PDF
      </a>
      <a href="{% url 'export_excel' projet.id %}" class="btn btn-mix-fresh btn-enhanced">
        <i class="fas fa-file-excel me-2"></i> Exporter Excel
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Apparition douce des sections au scroll
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('fade-in-up') })
  }, { threshold: .12, rootMargin:'0px 0px -40px 0px' });
  document.querySelectorAll('.category-section, .summary-section, .actions-section').forEach(s=>io.observe(s));

  // Animation simple des montants (HT, TVA, TTC & répartition)
  function animateValue(el, start, end, ms){
    const t0 = performance.now(), from = +start||0, to = +end||0;
    const fmt = new Intl.NumberFormat('fr-FR', { minimumFractionDigits:2, maximumFractionDigits:2 });
    function step(t){
      const p = Math.min(1, (t - t0)/ms);
      el.textContent = fmt.format(from + (to-from)*p) + ' CFA';
      if(p<1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }
  const amounts = document.querySelectorAll('.cost-value, .total-amount');
  const seen = new WeakSet();
  const amtIO = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting && !seen.has(e.target)){
        seen.add(e.target);
        const raw = (e.target.textContent||'').replace(/[^\d.,-]/g,'').replace(',', '.');
        const val = parseFloat(raw||'0');
        if(!isNaN(val)) animateValue(e.target, 0, val, 1200);
      }
    });
  }, { threshold:.6 });
  amounts.forEach(a=>amtIO.observe(a));

  // Boutons export : spinner court
  document.querySelectorAll('a[href*="export"]').forEach(btn=>{
    btn.addEventListener('click', function(){
      const html = this.innerHTML;
      this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Génération...';
      this.style.pointerEvents = 'none';
      setTimeout(()=>{ this.innerHTML = html; this.style.pointerEvents = 'auto' }, 2500);
    });
  });
});
</script>
{% endblock %}
